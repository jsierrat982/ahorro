<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mi Reto de Ahorro</title>
    
    <!-- Configuraci贸n PWA (Modo App) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Reto Ahorro">
    <meta name="theme-color" content="#10b981">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/000000/money-box.png">
    
    <!-- Librer铆as Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Configuraci贸n para Modo Oscuro manual
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            bg: '#0f172a',
                            card: '#1e293b',
                            text: '#f1f5f9'
                        }
                    }
                }
            }
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Estilos Personalizados -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        /* Transiciones suaves para modo oscuro */
        body, .cell, .modal-container, header, footer {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .cell:active { transform: scale(0.95); }
        .cell:hover { transform: translateY(-4px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); }

        /* Animaci贸n del Check */
        @keyframes popIn { 
            0% { transform: scale(0) rotate(-45deg); opacity: 0; } 
            70% { transform: scale(1.2) rotate(0deg); }
            100% { transform: scale(1) rotate(0deg); opacity: 1; } 
        }
        .check-icon { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        /* Animaci贸n Texto Flotante */
        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.8); opacity: 0; }
            20% { transform: translateY(-20px) scale(1.1); opacity: 1; }
            100% { transform: translateY(-60px) scale(1); opacity: 0; }
        }
        .floating-text {
            position: fixed; pointer-events: none; color: #10b981; font-weight: 800; font-size: 1.2rem; z-index: 100;
            animation: floatUp 1s ease-out forwards; text-shadow: 0 2px 4px rgba(255,255,255,0.8);
        }
        /* En modo oscuro, el texto flotante brilla m谩s */
        .dark .floating-text {
            text-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
            color: #34d399;
        }

        /* Notificaciones Toast */
        #toast-container {
            position: fixed; top: 20px; right: 20px; z-index: 9999;
            display: flex; flex-direction: column; gap: 10px; pointer-events: none;
        }
        .toast {
            background: white; padding: 12px 20px; border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 12px;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: auto; max-width: 90vw;
        }
        .dark .toast {
            background: #1f293b;
            color: #f1f5f9;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5);
        }

        .toast.show { transform: translateX(0); }
        .toast-success { border-left: 4px solid #10b981; }
        .toast-error { border-left: 4px solid #ef4444; }
        .toast-info { border-left: 4px solid #3b82f6; }

        /* Utilidades Modal y Loader */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }

        .loader {
            border-top-color: #10b981;
            -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Scrollbar Dark Mode */
        .dark ::-webkit-scrollbar { width: 8px; }
        .dark ::-webkit-scrollbar-track { background: #0f172a; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 text-gray-800 dark:text-gray-100 bg-[#f3f4f6] dark:bg-dark-bg transition-colors duration-300 pb-36">

    <!-- Contenedor de Notificaciones -->
    <div id="toast-container"></div>

    <div class="max-w-5xl mx-auto">
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 dark:text-white mb-2 drop-shadow-sm select-none transition-colors">
                    <i class="fas fa-piggy-bank text-emerald-500 mr-2 bounce-icon"></i>Reto de Ahorro
                </h1>
                <p class="text-gray-600 dark:text-gray-400 text-sm md:text-base transition-colors">
                    <span id="status-indicator" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 dark:bg-gray-800 text-gray-800 dark:text-gray-200 transition-colors duration-300 border border-gray-200 dark:border-gray-700">
                        <span class="w-2 h-2 mr-1 bg-gray-400 rounded-full"></span> Local
                    </span>
                </p>
            </div>
            
            <div class="flex gap-3">
                <!-- Bot贸n Tema -->
                <button onclick="toggleTheme()" class="bg-white dark:bg-gray-800 text-gray-800 dark:text-yellow-400 p-3 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700 transition shadow-md border border-gray-200 dark:border-gray-700" aria-label="Cambiar tema">
                    <i class="fas fa-moon dark:hidden"></i>
                    <i class="fas fa-sun hidden dark:inline"></i>
                </button>
                
                <!-- Bot贸n GitHub -->
                <button onclick="toggleModal('settings-modal')" class="bg-gray-900 dark:bg-gray-700 text-white px-5 py-2.5 rounded-lg hover:bg-gray-800 dark:hover:bg-gray-600 transition shadow-lg flex items-center gap-2 font-medium transform active:scale-95 text-sm md:text-base">
                    <i class="fab fa-github text-xl"></i> Configurar
                </button>
            </div>
        </header>

        <!-- GRID CONTAINER -->
        <div class="bg-white dark:bg-dark-card rounded-xl shadow-xl p-4 md:p-6 mb-8 relative overflow-hidden ring-1 ring-gray-100 dark:ring-gray-700 transition-colors duration-300">
            <div id="loading-overlay" class="hidden absolute inset-0 bg-white/90 dark:bg-gray-900/90 z-20 flex flex-col items-center justify-center transition-opacity backdrop-blur-sm">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 dark:border-gray-700 h-12 w-12 mb-4"></div>
                <h2 class="text-center text-gray-500 dark:text-gray-300 text-sm font-semibold">Sincronizando...</h2>
            </div>

            <div id="grid-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 md:gap-4">
                <!-- Se llena con JS -->
            </div>
        </div>
        
        <!-- Espaciador Footer -->
        <div class="h-24 md:h-0"></div>

        <!-- Footer Flotante -->
        <div class="fixed bottom-0 left-0 w-full bg-white/95 dark:bg-gray-900/95 backdrop-blur-md border-t border-gray-200 dark:border-gray-800 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] p-4 transform transition-transform duration-300 z-40 safe-area-bottom">
            <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-3 md:gap-4">
                
                <div class="flex items-center gap-4 w-full md:w-auto justify-between md:justify-start">
                    <div class="text-gray-600 dark:text-gray-300 whitespace-nowrap font-medium text-sm">
                        Progreso: <span id="progress-text" class="font-bold text-gray-900 dark:text-white">0/35</span>
                    </div>
                    <div class="w-32 md:w-48 h-3 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden shadow-inner">
                        <div id="progress-bar" class="h-full bg-gradient-to-r from-emerald-400 to-emerald-600 transition-all duration-700 ease-out" style="width: 0%"></div>
                    </div>
                </div>
                
                <div class="flex items-center justify-between w-full md:w-auto">
                    <div class="text-xl md:text-2xl font-bold text-gray-800 dark:text-white transition-colors">
                        <span class="text-sm font-normal text-gray-500 dark:text-gray-400 mr-2">Total:</span>
                        <span id="total-amount" class="text-emerald-600 dark:text-emerald-400">$ 0</span>
                    </div>

                    <div class="flex gap-3 text-sm font-medium md:ml-4">
                        <button onclick="toggleModal('history-modal'); renderHistory()" class="flex items-center text-purple-600 dark:text-purple-400 bg-purple-50 dark:bg-purple-900/20 p-2 rounded-lg active:bg-purple-100 dark:active:bg-purple-900/40 transition" title="Historial">
                            <i class="fas fa-history"></i>
                        </button>
                        <button onclick="syncData()" class="flex items-center text-blue-600 dark:text-blue-400 bg-blue-50 dark:bg-blue-900/20 p-2 rounded-lg active:bg-blue-100 dark:active:bg-blue-900/40 transition" title="Sincronizar">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button onclick="resetData()" class="flex items-center text-red-500 dark:text-red-400 bg-red-50 dark:bg-red-900/20 p-2 rounded-lg active:bg-red-100 dark:active:bg-red-900/40 transition" title="Reiniciar">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIG -->
    <div id="settings-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 p-4">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-60 backdrop-blur-sm" onclick="toggleModal('settings-modal')"></div>
        <div class="modal-container bg-white dark:bg-gray-800 w-full max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto transform transition-all scale-95 opacity-0" id="modal-content-settings">
            <div class="modal-content py-4 text-left px-6">
                <div class="flex justify-between items-center pb-3 border-b border-gray-100 dark:border-gray-700">
                    <p class="text-xl font-bold text-gray-800 dark:text-white"><i class="fab fa-github mr-2"></i>Conexi贸n GitHub</p>
                    <div class="modal-close cursor-pointer p-2 dark:text-gray-400" onclick="toggleModal('settings-modal')"><i class="fas fa-times"></i></div>
                </div>
                <div class="my-5 space-y-4">
                    <div class="bg-blue-50 dark:bg-blue-900/30 border-l-4 border-blue-500 p-3 rounded-r text-sm text-blue-700 dark:text-blue-300">
                        Tus datos se guardan en tu repositorio de GitHub.
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1">Usuario</label>
                        <input type="text" id="gh-username" placeholder="Ej: jsierrat982" class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none bg-white dark:bg-gray-700 dark:text-white transition-colors">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1">Repositorio</label>
                        <input type="text" id="gh-repo" placeholder="Ej: ahorro" class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none bg-white dark:bg-gray-700 dark:text-white transition-colors">
                    </div>
                    <div>
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-1">Token (Classic)</label>
                        <input type="password" id="gh-token" placeholder="ghp_..." class="w-full px-3 py-2 border dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-emerald-500 outline-none bg-white dark:bg-gray-700 dark:text-white transition-colors">
                    </div>
                </div>
                <div class="flex justify-end pt-2 border-t border-gray-100 dark:border-gray-700">
                    <button onclick="saveSettings()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-700 rounded-lg text-white font-bold text-sm shadow transition">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL HISTORIAL -->
    <div id="history-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50 p-4">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-60 backdrop-blur-sm" onclick="toggleModal('history-modal')"></div>
        <div class="modal-container bg-white dark:bg-gray-800 w-full max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-hidden flex flex-col max-h-[80vh] transform transition-all scale-95 opacity-0" id="modal-content-history">
            <div class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-white dark:bg-gray-800 sticky top-0 z-10">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white"><i class="fas fa-history mr-2 text-purple-500"></i>Movimientos</h3>
                <div class="cursor-pointer p-2 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition" onclick="toggleModal('history-modal')">
                    <i class="fas fa-times"></i>
                </div>
            </div>
            <div id="history-list" class="overflow-y-auto p-4 space-y-2 bg-gray-50 dark:bg-gray-900/50 flex-1">
                <!-- Se llena con JS -->
                <p class="text-center text-gray-500 py-4">No hay movimientos registrados.</p>
            </div>
            <div class="px-6 py-3 border-t border-gray-100 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 text-right">
                <span class="text-xs text-gray-500 dark:text-gray-400">Ordenado por fecha (Reciente primero)</span>
            </div>
        </div>
    </div>

    <!-- LGICA DE LA APP INTEGRADA -->
    <script>
        // === CONFIGURACIN GLOBAL ===
        const columnValues = [160000, 170000, 180000, 190000, 200000];
        const totalRows = 7; 
        const LOCAL_STORAGE_KEY = 'savings_data_v2'; 
        const CONFIG_KEY = 'github_config_v2';
        const THEME_KEY = 'savings_theme_preference';

        // === ESTADO DE LA APP ===
        let appState = {};
        let ghConfig = { username: '', repo: '', token: '', filename: 'datos_ahorro.json' };
        let currentFileSha = null;

        // === INICIO ===
        document.addEventListener('DOMContentLoaded', () => {
            loadTheme();      // Cargar preferencia de color
            loadLocalConfig();
            renderGrid();
            
            if (isConfigured()) {
                loadFromGitHub();
            } else {
                loadLocalData();
            }
        });

        // === MODO OSCURO ===
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem(THEME_KEY, 'light');
            } else {
                html.classList.add('dark');
                localStorage.setItem(THEME_KEY, 'dark');
            }
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem(THEME_KEY);
            // Preferencia guardada O preferencia del sistema
            if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }

        // === HISTORIAL ===
        function renderHistory() {
            const listContainer = document.getElementById('history-list');
            const entries = Object.values(appState).sort((a, b) => b.timestamp - a.timestamp); // M谩s reciente primero

            if (entries.length === 0) {
                listContainer.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-8 text-gray-400 dark:text-gray-500 opacity-60">
                        <i class="fas fa-history text-4xl mb-2"></i>
                        <p>A煤n no has comenzado tu ahorro.</p>
                    </div>`;
                return;
            }

            let html = '';
            entries.forEach(entry => {
                html += `
                    <div class="flex justify-between items-center bg-white dark:bg-gray-800 p-3 rounded-lg border border-gray-100 dark:border-gray-700 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600 dark:text-emerald-400 w-8 h-8 rounded-full flex items-center justify-center">
                                <i class="fas fa-check text-xs"></i>
                            </div>
                            <div>
                                <p class="font-bold text-gray-800 dark:text-gray-200">${formatCurrency(entry.value)}</p>
                                <p class="text-xs text-gray-500 dark:text-gray-400">${entry.date}</p>
                            </div>
                        </div>
                    </div>
                `;
            });
            listContainer.innerHTML = html;
        }

        // === NOTIFICACIONES TOAST ===
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            
            let icon = 'info-circle';
            let colorClass = 'toast-info';
            let iconColor = 'text-blue-500';
            
            if (type === 'success') { icon = 'check-circle'; colorClass = 'toast-success'; iconColor = 'text-emerald-500'; }
            if (type === 'error') { icon = 'exclamation-circle'; colorClass = 'toast-error'; iconColor = 'text-red-500'; }

            toast.className = `toast ${colorClass}`;
            toast.innerHTML = `
                <i class="fas fa-${icon} text-lg ${iconColor}"></i>
                <span class="font-medium text-sm text-gray-700 dark:text-gray-200">${message}</span>
            `;

            container.appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // === LOGICA PRINCIPAL ===
        function toggleCell(event, index, value) {
            let justCompleted = false;

            if (appState[index]) {
                delete appState[index]; // Desmarcar
            } else {
                const now = new Date();
                appState[index] = {
                    value: value,
                    date: now.toLocaleDateString('es-CO', { day: 'numeric', month: 'short', year: 'numeric' }),
                    timestamp: now.getTime()
                };
                justCompleted = true; 
            }
            
            updateCellVisuals(index);
            updateSummary();
            
            if (justCompleted) {
                triggerSmallConfetti(event);
                showFloatingText(event, value);
                checkTotalCompletion();
            }

            saveData();
            // Si el modal de historial est谩 abierto, actual铆zalo en tiempo real
            if(!document.getElementById('history-modal').classList.contains('pointer-events-none')){
                renderHistory();
            }
        }

        // --- EFECTOS VISUALES ---
        function triggerSmallConfetti(e) {
            const x = e.clientX / window.innerWidth;
            const y = e.clientY / window.innerHeight;
            confetti({ particleCount: 40, spread: 50, origin: { x: x, y: y }, colors: ['#10b981', '#34d399', '#fbbf24'], disableForReducedMotion: true, zIndex: 100 });
        }

        function showFloatingText(e, value) {
            const formatted = formatCurrency(value);
            const el = document.createElement('div');
            el.className = 'floating-text';
            el.textContent = `+ ${formatted}`;
            el.style.left = `${e.clientX}px`;
            el.style.top = `${e.clientY}px`;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        function checkTotalCompletion() {
            const totalCells = totalRows * columnValues.length;
            const currentCount = Object.keys(appState).length;
            if (currentCount === totalCells) {
                setTimeout(() => {
                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
                    showToast("隆Felicidades! Reto completado ", 'success');
                }, 500);
            }
        }

        // === PERSISTENCIA Y GITHUB ===
        async function saveData() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appState));
            if (isConfigured()) await saveToGitHub();
        }

        function isConfigured() { return ghConfig.token && ghConfig.username && ghConfig.repo; }

        async function loadFromGitHub() {
            toggleLoading(true);
            updateStatus('Conectando...', 'yellow');
            const url = `https://api.github.com/repos/${ghConfig.username}/${ghConfig.repo}/contents/${ghConfig.filename}`;

            try {
                const response = await fetch(url, { headers: { 'Authorization': `token ${ghConfig.token}`, 'Accept': 'application/vnd.github.v3+json' }, cache: 'no-store' });
                if (response.status === 404) {
                    currentFileSha = null;
                    updateStatus('Conectado (Nuevo)', 'green');
                } else if (response.ok) {
                    const data = await response.json();
                    currentFileSha = data.sha;
                    appState = JSON.parse(decodeURIComponent(escape(window.atob(data.content))));
                    refreshGridUI();
                    updateStatus('Sincronizado', 'green');
                    showToast('Datos cargados correctamente', 'success');
                } else {
                    handleGithubError(response.status);
                }
            } catch (error) {
                updateStatus('Error Conexi贸n', 'red');
                showToast('Error de conexi贸n. Usando datos locales.', 'error');
                loadLocalData();
            } finally {
                toggleLoading(false);
            }
        }

        async function saveToGitHub() {
            updateStatus('Guardando...', 'blue');
            const url = `https://api.github.com/repos/${ghConfig.username}/${ghConfig.repo}/contents/${ghConfig.filename}`;
            const jsonString = JSON.stringify(appState, null, 2);
            const contentBase64 = window.btoa(unescape(encodeURIComponent(jsonString)));
            const body = { message: `Update: ${new Date().toLocaleString()}`, content: contentBase64 };
            if (currentFileSha) body.sha = currentFileSha;

            try {
                const response = await fetch(url, { method: 'PUT', headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (response.ok) {
                    const data = await response.json();
                    currentFileSha = data.content.sha;
                    updateStatus('Guardado', 'green');
                } else {
                    handleGithubError(response.status);
                    updateStatus('Error al Guardar', 'red');
                }
            } catch (error) {
                updateStatus('Error Red', 'red');
                showToast('Error de red al guardar', 'error');
            }
        }

        function handleGithubError(status) {
            if(status === 409) showToast('Conflicto: Recarga la p谩gina para sincronizar.', 'info');
            else if(status === 401) showToast('Error 401: Token inv谩lido.', 'error');
            else if(status === 404) showToast('Error 404: Repositorio no encontrado.', 'error');
            else showToast(`Error GitHub: ${status}`, 'error');
        }

        // === UI UTILS ===
        function renderGrid() {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';
            let index = 0;
            for (let row = 0; row < totalRows; row++) {
                for (let col = 0; col < columnValues.length; col++) {
                    const value = columnValues[col];
                    const cellId = index;
                    const cell = document.createElement('div');
                    cell.id = `cell-${cellId}`;
                    // Clases base + soporte dark mode
                    cell.className = 'cell relative bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700 rounded-xl cursor-pointer h-24 select-none overflow-hidden group hover:border-emerald-200 dark:hover:border-gray-600';
                    cell.onclick = (e) => toggleCell(e, cellId, value);
                    
                    cell.innerHTML = `
                        <div class="content w-full h-full flex flex-col items-center justify-center p-2">
                             <span class="text-gray-700 dark:text-gray-300 text-lg font-bold tracking-tight group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors">
                                ${formatCurrency(value)}
                            </span>
                            <span class="text-[10px] text-gray-400 dark:text-gray-500 mt-1 uppercase font-semibold tracking-wider">Marcar</span>
                        </div>
                    `;
                    container.appendChild(cell);
                    index++;
                }
            }
        }

        function updateCellVisuals(index) {
            const cell = document.getElementById(`cell-${index}`);
            if (!cell) return;
            const data = appState[index];
            
            if (data) {
                // Estado: MARCADO (con soporte dark mode)
                cell.className = 'cell relative bg-emerald-50 dark:bg-emerald-900/20 border-2 border-emerald-500 dark:border-emerald-600 rounded-xl cursor-pointer h-24 select-none overflow-hidden shadow-md transform scale-[0.98]';
                cell.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full animate-fade-in">
                        <div class="text-emerald-700 dark:text-emerald-400 text-lg font-bold mb-1">${formatCurrency(data.value)}</div>
                        <div class="flex items-center text-[10px] text-emerald-800 dark:text-emerald-300 bg-emerald-200/50 dark:bg-emerald-800/40 px-2 py-0.5 rounded-full font-medium">
                            ${data.date}
                        </div>
                    </div>
                    <div class="absolute top-1 right-1 check-icon">
                        <i class="fas fa-check-circle text-emerald-500 dark:text-emerald-400 text-lg drop-shadow-sm"></i>
                    </div>
                `;
            } else {
                // Estado: DESMARCADO
                const value = columnValues[index % columnValues.length];
                cell.className = 'cell relative bg-white dark:bg-gray-800 border-2 border-gray-100 dark:border-gray-700 rounded-xl cursor-pointer h-24 select-none overflow-hidden group hover:border-emerald-200 dark:hover:border-gray-600';
                cell.innerHTML = `
                    <div class="content w-full h-full flex flex-col items-center justify-center p-2">
                         <span class="text-gray-700 dark:text-gray-300 text-lg font-bold tracking-tight group-hover:text-emerald-600 dark:group-hover:text-emerald-400 transition-colors">
                            ${formatCurrency(value)}
                        </span>
                        <span class="text-[10px] text-gray-400 dark:text-gray-500 mt-1 uppercase font-semibold tracking-wider group-hover:text-emerald-400">Tocar</span>
                    </div>
                `;
            }
        }

        function refreshGridUI() {
            for (let i = 0; i < totalRows * columnValues.length; i++) updateCellVisuals(i);
            updateSummary();
        }

        function updateSummary() {
            const entries = Object.values(appState);
            const count = entries.length;
            const total = entries.reduce((sum, item) => sum + item.value, 0);
            const max = totalRows * columnValues.length;
            
            document.getElementById('progress-text').textContent = `${count}/${max}`;
            document.getElementById('total-amount').textContent = formatCurrency(total);
            document.getElementById('progress-bar').style.width = `${(count / max) * 100}%`;
        }

        function formatCurrency(val) { return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP', minimumFractionDigits: 0 }).format(val); }

        function updateStatus(msg, color) {
            const el = document.getElementById('status-indicator');
            const dot = el.querySelector('span');
            const colors = {
                green: ['bg-emerald-100 dark:bg-emerald-900', 'text-emerald-800 dark:text-emerald-200', 'bg-emerald-500'],
                yellow: ['bg-yellow-100 dark:bg-yellow-900', 'text-yellow-800 dark:text-yellow-200', 'bg-yellow-500'],
                red: ['bg-red-100 dark:bg-red-900', 'text-red-800 dark:text-red-200', 'bg-red-500'],
                blue: ['bg-blue-100 dark:bg-blue-900', 'text-blue-800 dark:text-blue-200', 'bg-blue-500']
            };
            const [bg, text, dotBg] = colors[color] || ['bg-gray-100', 'text-gray-800', 'bg-gray-400'];
            el.className = `inline-flex items-center px-2 py-0.5 rounded text-xs font-medium transition-colors duration-300 ${bg} ${text} border border-transparent dark:border-white/10`;
            dot.className = `w-2 h-2 mr-1 rounded-full ${dotBg}`;
            el.innerHTML = `<span class="${dot.className}"></span> ${msg}`;
        }

        function toggleLoading(show) { document.getElementById('loading-overlay').classList.toggle('hidden', !show); }

        function resetData() {
            if(confirm('驴Reiniciar todo?')) {
                appState = {}; localStorage.removeItem(LOCAL_STORAGE_KEY); refreshGridUI(); saveData();
            }
        }

        function syncData() { if (isConfigured()) loadFromGitHub(); else toggleModal('settings-modal'); }

        function loadLocalData() {
            const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (stored) { try { appState = JSON.parse(stored); refreshGridUI(); } catch (e) { appState = {}; } }
        }

        function loadLocalConfig() {
            const stored = localStorage.getItem(CONFIG_KEY);
            if (stored) {
                ghConfig = JSON.parse(stored);
                document.getElementById('gh-username').value = ghConfig.username || '';
                document.getElementById('gh-repo').value = ghConfig.repo || '';
                document.getElementById('gh-token').value = ghConfig.token || '';
            }
        }

        function saveSettings() {
            const u = document.getElementById('gh-username').value.trim();
            const r = document.getElementById('gh-repo').value.trim();
            const t = document.getElementById('gh-token').value.trim();
            if (!u || !r || !t) { showToast('Todos los campos son obligatorios.', 'error'); return; }
            ghConfig = { username: u, repo: r, token: t, filename: 'datos_ahorro.json' };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(ghConfig));
            toggleModal('settings-modal');
            loadFromGitHub();
        }

        function toggleModal(id) {
            const modal = document.getElementById(id);
            const content = modal.querySelector(id === 'settings-modal' ? '#modal-content-settings' : '#modal-content-history');
            
            if (!modal.classList.contains('opacity-0')) {
                modal.classList.add('opacity-0', 'pointer-events-none');
                content.classList.remove('scale-100', 'opacity-100');
                content.classList.add('scale-95', 'opacity-0');
                document.body.classList.remove('modal-active');
            } else {
                modal.classList.remove('opacity-0', 'pointer-events-none');
                setTimeout(() => { content.classList.remove('scale-95', 'opacity-0'); content.classList.add('scale-100', 'opacity-100'); }, 10);
                document.body.classList.add('modal-active');
            }
        }
    </script>
</body>
</html>
