<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Reto de Ahorro</title>
    
    <!-- Estilos Externos (Tailwind CSS y Fuentes) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Estilos Personalizados (CSS) -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f3f4f6; 
        }
        
        /* Efectos de la cuadrícula */
        .cell { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .cell:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); 
        }
        
        /* Animación del Check */
        @keyframes scaleIn { 
            from { transform: scale(0); opacity: 0; } 
            to { transform: scale(1); opacity: 1; } 
        }
        .check-icon { 
            animation: scaleIn 0.3s ease-out forwards; 
        }
        
        /* Utilidades para el Modal */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }

        /* Loader */
        .loader {
            border-top-color: #10b981;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 text-gray-800">

    <div class="max-w-5xl mx-auto">
        <!-- HEADER -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
            <div class="text-center md:text-left">
                <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
                    <i class="fas fa-piggy-bank text-emerald-500 mr-2"></i>Reto de Ahorro
                </h1>
                <p class="text-gray-600">
                    <span id="status-indicator" class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 transition-colors duration-300">
                        <span class="w-2 h-2 mr-1 bg-gray-400 rounded-full"></span> Local
                    </span>
                    Gestiona tu progreso en la nube.
                </p>
            </div>
            <button onclick="toggleModal('settings-modal')" class="bg-gray-900 text-white px-5 py-2.5 rounded-lg hover:bg-gray-800 transition shadow-lg flex items-center gap-2 font-medium">
                <i class="fab fa-github text-xl"></i> Configurar GitHub
            </button>
        </header>

        <!-- GRID CONTAINER -->
        <div class="bg-white rounded-xl shadow-xl p-4 md:p-6 mb-24 relative overflow-hidden">
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="hidden absolute inset-0 bg-white/90 z-20 flex flex-col items-center justify-center transition-opacity">
                <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
                <h2 class="text-center text-gray-500 text-sm font-semibold">Sincronizando con GitHub...</h2>
            </div>

            <!-- Grid JS Target -->
            <div id="grid-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-3 md:gap-4">
                <!-- Las celdas se generan aquí -->
            </div>
        </div>

        <!-- FOOTER / RESUMEN -->
        <div class="fixed bottom-0 left-0 w-full bg-white/95 backdrop-blur-sm border-t border-gray-200 shadow-[0_-4px_20px_rgba(0,0,0,0.05)] p-4 transform transition-transform duration-300 z-40">
            <div class="max-w-5xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
                
                <!-- Barra de Progreso -->
                <div class="flex items-center gap-4 w-full md:w-auto">
                    <div class="text-gray-600 whitespace-nowrap font-medium">
                        Progreso: <span id="progress-text" class="font-bold text-gray-900">0/35</span>
                    </div>
                    <div class="w-full md:w-48 h-3 bg-gray-200 rounded-full overflow-hidden">
                        <div id="progress-bar" class="h-full bg-emerald-500 transition-all duration-700 ease-out shadow-[0_0_10px_rgba(16,185,129,0.5)]" style="width: 0%"></div>
                    </div>
                </div>
                
                <!-- Total Dinero -->
                <div class="text-2xl font-bold text-gray-800">
                    <span class="text-sm font-normal text-gray-500 mr-2">Total:</span>
                    <span id="total-amount" class="text-emerald-600">$ 0</span>
                </div>

                <!-- Botones de Acción -->
                <div class="flex gap-4 text-sm font-medium">
                    <button onclick="syncData()" class="flex items-center text-blue-600 hover:text-blue-800 bg-blue-50 hover:bg-blue-100 px-3 py-1.5 rounded transition">
                        <i class="fas fa-sync-alt mr-2"></i> Sincronizar
                    </button>
                    <button onclick="resetData()" class="flex items-center text-red-500 hover:text-red-700 hover:bg-red-50 px-3 py-1.5 rounded transition">
                        <i class="fas fa-trash-alt mr-2"></i> Reiniciar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CONFIGURACIÓN GITHUB -->
    <div id="settings-modal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-60 backdrop-blur-sm" onclick="toggleModal('settings-modal')"></div>
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded-xl shadow-2xl z-50 overflow-y-auto transform transition-all scale-95 opacity-0" id="modal-content">
            
            <div class="modal-content py-4 text-left px-6">
                <!-- Header Modal -->
                <div class="flex justify-between items-center pb-3 border-b border-gray-100">
                    <p class="text-xl font-bold text-gray-800"><i class="fab fa-github mr-2"></i>Conexión GitHub</p>
                    <div class="modal-close cursor-pointer z-50 p-2 hover:bg-gray-100 rounded-full transition" onclick="toggleModal('settings-modal')">
                        <i class="fas fa-times text-gray-500"></i>
                    </div>
                </div>

                <!-- Body Modal -->
                <div class="my-5 space-y-4">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r">
                        <div class="flex">
                            <div class="flex-shrink-0">
                                <i class="fas fa-info-circle text-blue-500"></i>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-blue-700">
                                    Tus datos se guardarán en un archivo JSON dentro de tu repositorio privado o público.
                                </p>
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Usuario de GitHub</label>
                        <input type="text" id="gh-username" placeholder="Ej: jsierrat982" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Nombre del Repositorio</label>
                        <input type="text" id="gh-repo" placeholder="Ej: ahorro" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">
                            Personal Access Token
                            <a href="https://github.com/settings/tokens" target="_blank" class="text-emerald-600 hover:text-emerald-800 text-xs float-right font-normal underline">Crear Token (Classic)</a>
                        </label>
                        <input type="password" id="gh-token" placeholder="ghp_xxxxxxxxxxxx" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-transparent transition">
                        <p class="text-xs text-gray-500 mt-1">Requiere permisos 'repo' (privado) o 'public_repo'.</p>
                    </div>
                </div>

                <!-- Footer Modal -->
                <div class="flex justify-end pt-2 border-t border-gray-100">
                    <button onclick="toggleModal('settings-modal')" class="px-4 py-2 bg-transparent p-3 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-gray-700 mr-2 text-sm font-medium">Cancelar</button>
                    <button onclick="saveSettings()" class="px-6 py-2 bg-emerald-600 rounded-lg text-white hover:bg-emerald-700 shadow-md transform hover:-translate-y-0.5 transition font-bold text-sm">Guardar y Conectar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- LÓGICA DE LA APLICACIÓN (SCRIPT) -->
    <script>
        // === CONFIGURACIÓN GLOBAL ===
        // Genera la cuadrícula de $160k a $200k
        const columnValues = [160000, 170000, 180000, 190000, 200000];
        const totalRows = 7; 
        const LOCAL_STORAGE_KEY = 'savings_data_v2'; // Clave para guardar en navegador
        const CONFIG_KEY = 'github_config_v2';       // Clave para guardar credenciales

        // === ESTADO DE LA APP ===
        let appState = {};
        let ghConfig = { username: '', repo: '', token: '', filename: 'datos_ahorro.json' };
        let currentFileSha = null;

        // === INICIO ===
        document.addEventListener('DOMContentLoaded', () => {
            loadLocalConfig();
            renderGrid();
            
            // Prioridad: Intentar cargar de GitHub si existen credenciales
            if (isConfigured()) {
                loadFromGitHub();
            } else {
                loadLocalData();
            }
        });

        // === LÓGICA DE NEGOCIO ===
        function toggleCell(index, value) {
            // Alternar estado de la celda
            if (appState[index]) {
                delete appState[index]; // Desmarcar
            } else {
                const now = new Date();
                appState[index] = {
                    value: value,
                    date: now.toLocaleDateString('es-CO', { day: 'numeric', month: 'short', year: 'numeric' }),
                    timestamp: now.getTime()
                };
            }
            
            // Actualización optimista (UI primero)
            updateCellVisuals(index);
            updateSummary();
            
            // Guardar datos
            saveData();
        }

        async function saveData() {
            // 1. Siempre guardar respaldo local
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(appState));

            // 2. Si hay GitHub configurado, guardar en la nube
            if (isConfigured()) {
                await saveToGitHub();
            }
        }

        // === INTEGRACIÓN GITHUB (API) ===
        function isConfigured() {
            return ghConfig.token && ghConfig.username && ghConfig.repo;
        }

        async function loadFromGitHub() {
            toggleLoading(true);
            updateStatus('Conectando...', 'yellow');

            const url = `https://api.github.com/repos/${ghConfig.username}/${ghConfig.repo}/contents/${ghConfig.filename}`;

            try {
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `token ${ghConfig.token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    cache: 'no-store' // Evitar caché antigua
                });

                if (response.status === 404) {
                    // Archivo nuevo
                    console.log("Archivo no existe en GitHub. Se creará al guardar.");
                    currentFileSha = null;
                    updateStatus('Conectado (Nuevo)', 'green');
                } else if (response.ok) {
                    const data = await response.json();
                    currentFileSha = data.sha;
                    
                    // Decodificar Base64 de forma segura con UTF-8
                    const content = decodeURIComponent(escape(window.atob(data.content)));
                    appState = JSON.parse(content);
                    
                    refreshGridUI();
                    updateStatus('Sincronizado', 'green');
                } else {
                    throw new Error(`GitHub API: ${response.status}`);
                }
            } catch (error) {
                console.error("Error GitHub:", error);
                updateStatus('Error Conexión', 'red');
                // Fallback a local si falla GitHub
                loadLocalData();
            } finally {
                toggleLoading(false);
            }
        }

        async function saveToGitHub() {
            updateStatus('Guardando...', 'blue');
            const url = `https://api.github.com/repos/${ghConfig.username}/${ghConfig.repo}/contents/${ghConfig.filename}`;
            
            // Preparar contenido Base64
            const jsonString = JSON.stringify(appState, null, 2);
            const contentBase64 = window.btoa(unescape(encodeURIComponent(jsonString)));

            const body = {
                message: `Update: ${new Date().toLocaleString()}`,
                content: contentBase64
            };

            if (currentFileSha) {
                body.sha = currentFileSha;
            }

            try {
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${ghConfig.token}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(body)
                });

                if (response.ok) {
                    const data = await response.json();
                    currentFileSha = data.content.sha;
                    updateStatus('Guardado en GitHub', 'green');
                } else {
                    updateStatus('Error al Guardar', 'red');
                }
            } catch (error) {
                console.error(error);
                updateStatus('Error Red', 'red');
            }
        }

        // === GESTIÓN DE UI ===
        function renderGrid() {
            const container = document.getElementById('grid-container');
            container.innerHTML = '';
            
            let index = 0;
            for (let row = 0; row < totalRows; row++) {
                for (let col = 0; col < columnValues.length; col++) {
                    const value = columnValues[col];
                    const cellId = index;
                    
                    const cell = document.createElement('div');
                    cell.id = `cell-${cellId}`;
                    cell.className = 'cell relative bg-white border-2 border-gray-100 rounded-xl cursor-pointer h-24 select-none overflow-hidden group';
                    cell.onclick = () => toggleCell(cellId, value);
                    
                    // Contenido inicial (se actualiza luego)
                    cell.innerHTML = `
                        <div class="content w-full h-full flex flex-col items-center justify-center p-2">
                             <span class="text-gray-700 text-lg font-bold tracking-tight group-hover:text-emerald-600 transition-colors">
                                ${formatCurrency(value)}
                            </span>
                            <span class="text-[10px] text-gray-400 mt-1 uppercase font-semibold tracking-wider">Marcar</span>
                        </div>
                    `;
                    
                    container.appendChild(cell);
                    index++;
                }
            }
        }

        function updateCellVisuals(index) {
            const cell = document.getElementById(`cell-${index}`);
            if (!cell) return;
            
            const data = appState[index];
            const contentDiv = cell.querySelector('.content');
            
            if (data) {
                // Estado: MARCADO
                cell.className = 'cell relative bg-emerald-50 border-2 border-emerald-500 rounded-xl cursor-pointer h-24 select-none overflow-hidden shadow-md transform scale-[0.98]';
                cell.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full animate-fade-in">
                        <div class="text-emerald-700 text-lg font-bold mb-1">${formatCurrency(data.value)}</div>
                        <div class="flex items-center text-[10px] text-emerald-800 bg-emerald-200/50 px-2 py-0.5 rounded-full font-medium">
                            ${data.date}
                        </div>
                    </div>
                    <div class="absolute top-1 right-1 check-icon">
                        <i class="fas fa-check-circle text-emerald-500 text-lg drop-shadow-sm"></i>
                    </div>
                `;
            } else {
                // Estado: DESMARCADO (Reset)
                // Obtenemos valor original del array
                const colIndex = index % columnValues.length;
                const value = columnValues[colIndex];
                
                cell.className = 'cell relative bg-white border-2 border-gray-100 rounded-xl cursor-pointer h-24 select-none overflow-hidden group hover:border-emerald-200';
                cell.innerHTML = `
                    <div class="content w-full h-full flex flex-col items-center justify-center p-2">
                         <span class="text-gray-700 text-lg font-bold tracking-tight group-hover:text-emerald-600 transition-colors">
                            ${formatCurrency(value)}
                        </span>
                        <span class="text-[10px] text-gray-400 mt-1 uppercase font-semibold tracking-wider group-hover:text-emerald-400">Tocar</span>
                    </div>
                `;
            }
        }

        function refreshGridUI() {
            const totalCells = totalRows * columnValues.length;
            for (let i = 0; i < totalCells; i++) {
                updateCellVisuals(i);
            }
            updateSummary();
        }

        function updateSummary() {
            const entries = Object.values(appState);
            const count = entries.length;
            const total = entries.reduce((sum, item) => sum + item.value, 0);
            const max = totalRows * columnValues.length;
            
            // Textos
            document.getElementById('progress-text').textContent = `${count}/${max}`;
            document.getElementById('total-amount').textContent = formatCurrency(total);
            
            // Barra progreso
            const pct = (count / max) * 100;
            document.getElementById('progress-bar').style.width = `${pct}%`;
        }

        // === UTILIDADES ===
        function formatCurrency(val) {
            return new Intl.NumberFormat('es-CO', { 
                style: 'currency', 
                currency: 'COP', 
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(val);
        }

        function updateStatus(msg, color) {
            const el = document.getElementById('status-indicator');
            const dot = el.querySelector('span');
            
            // Clases de colores Tailwind
            const colors = {
                green: ['bg-emerald-100', 'text-emerald-800', 'bg-emerald-500'],
                yellow: ['bg-yellow-100', 'text-yellow-800', 'bg-yellow-500'],
                red: ['bg-red-100', 'text-red-800', 'bg-red-500'],
                blue: ['bg-blue-100', 'text-blue-800', 'bg-blue-500']
            };
            
            const [bg, text, dotBg] = colors[color] || ['bg-gray-100', 'text-gray-800', 'bg-gray-400'];
            
            el.className = `inline-flex items-center px-2 py-0.5 rounded text-xs font-medium transition-colors duration-300 ${bg} ${text}`;
            dot.className = `w-2 h-2 mr-1 rounded-full ${dotBg}`;
            el.innerHTML = `<span class="${dot.className}"></span> ${msg}`;
        }

        function toggleLoading(show) {
            const el = document.getElementById('loading-overlay');
            el.classList.toggle('hidden', !show);
        }

        function resetData() {
            if(confirm('¿Estás seguro de reiniciar todo el progreso? Esto borrará los datos locales y en GitHub.')) {
                appState = {};
                localStorage.removeItem(LOCAL_STORAGE_KEY);
                refreshGridUI();
                saveData();
            }
        }
        
        function syncData() {
            if (isConfigured()) loadFromGitHub();
            else toggleModal('settings-modal');
        }

        // === CARGA LOCAL (AÑADIDA) ===
        function loadLocalData() {
            const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (stored) {
                try {
                    appState = JSON.parse(stored);
                    refreshGridUI();
                } catch (e) {
                    console.error("Error cargando datos locales:", e);
                    // Si falla el parseo, reiniciamos el estado para evitar bloqueos
                    appState = {};
                }
            }
        }

        // === CONFIGURACIÓN DE CREDENCIALES ===
        function loadLocalConfig() {
            const stored = localStorage.getItem(CONFIG_KEY);
            if (stored) {
                ghConfig = JSON.parse(stored);
                document.getElementById('gh-username').value = ghConfig.username || '';
                document.getElementById('gh-repo').value = ghConfig.repo || '';
                document.getElementById('gh-token').value = ghConfig.token || '';
            }
        }

        function saveSettings() {
            const u = document.getElementById('gh-username').value.trim();
            const r = document.getElementById('gh-repo').value.trim();
            const t = document.getElementById('gh-token').value.trim();
            
            if (!u || !r || !t) {
                alert('Todos los campos son obligatorios para conectar.');
                return;
            }
            
            ghConfig = { username: u, repo: r, token: t, filename: 'datos_ahorro.json' };
            localStorage.setItem(CONFIG_KEY, JSON.stringify(ghConfig));
            
            toggleModal('settings-modal');
            loadFromGitHub();
        }

        // Modal Helpers
        function toggleModal(id) {
            const modal = document.getElementById(id);
            const content = modal.querySelector('#modal-content');
            
            const isActive = !modal.classList.contains('opacity-0');
            
            if (isActive) {
                // Cerrar
                modal.classList.add('opacity-0', 'pointer-events-none');
                content.classList.remove('scale-100', 'opacity-100');
                content.classList.add('scale-95', 'opacity-0');
                document.body.classList.remove('modal-active');
            } else {
                // Abrir
                modal.classList.remove('opacity-0', 'pointer-events-none');
                // Timeout pequeño para permitir que la clase opacity-0 se quite antes de animar
                setTimeout(() => {
                    content.classList.remove('scale-95', 'opacity-0');
                    content.classList.add('scale-100', 'opacity-100');
                }, 10);
                document.body.classList.add('modal-active');
            }
        }
    </script>
</body>
</html>